# Step 8: BPMN Workflow Visualization

**Created:** 2025-01-04
**Status:** In Progress
**Related:** GUARDIAN_REDESIGN_PLAN.md, PHASE_4A_IMPLEMENTATION_SUMMARY.md

## Problem Statement

**Current Issue:** Step 8 "Review Policy Structure" shows workflow metadata (schema count, step count, roles) but doesn't visualize the actual workflow. Users cannot see:
- What steps will execute
- In what order
- What decision points exist
- Who is responsible for each step
- What data flows between steps

**User Feedback:** "There should be some visual representation of the workflows... currently it is a blackbox and we wouldn't know what exactly we will be testing."

**Business Impact:** Users need to understand the workflow before testing (Step 9) to:
- Verify correctness
- Understand compliance checkpoints
- Identify role assignments
- Estimate execution time

## Solution: BPMN 2.0 Visualization

### Technology Decision: bpmn-js

**Chosen:** bpmn-js (by Camunda/bpmn.io)

**Why NOT Flowable:**
- Flowable is a full **execution engine** (like Guardian)
- Requires Java backend
- We only need **visualization** (frontend)
- Guardian already handles execution on Hedera blockchain

**Why bpmn-js:**
- ✅ Pure frontend library (React-compatible)
- ✅ Renders BPMN 2.0 XML (industry standard)
- ✅ Guardian MCP returns BPMN XML in Phase 4B
- ✅ Lightweight (~200KB gzipped)
- ✅ Used by Camunda, Flowable UI uses similar
- ✅ Read-only viewer for our use case

**Dependencies:**
```json
{
  "bpmn-js": "^14.0.0",
  "diagram-js": "^12.0.0"
}
```

### Design Inspiration: ServiceNow Flow Designer

**Reference:** ServiceNow Flow Designer is best-in-class for workflow visualization

**Key Patterns Adopted:**
1. **3-column layout** - Navigator | Canvas | Details
2. **Workflow hierarchy** - Main workflow + expandable sub-workflows
3. **Click-to-inspect** - Click any step to see details
4. **Read-only viewer** - No editing (workflows generated by Guardian)
5. **Professional appearance** - Clean, business-appropriate UI

## Architecture

### Layout Structure (ServiceNow-Inspired)

```
┌──────────────────────────────────────────────────────────────────┐
│ Step 8: Review Policy Structure                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌────────────────────────┐  ┌─────────────┐ │
│  │ Workflow     │  │  BPMN Canvas           │  │  Details    │ │
│  │ Navigator    │  │  (bpmn-js viewer)      │  │  Panel      │ │
│  │              │  │                         │  │  (slides in)│ │
│  │ ▼ Main       │  │  ┌──────┐   ┌──────┐  │  │             │ │
│  │   Sukuk      │  │  │Start │ →│Review│  │  │  Selected:  │ │
│  │   Issuance   │  │  └──────┘   └──────┘  │  │  "Shariah   │ │
│  │              │  │      ↓         ↓       │  │   Review"   │ │
│  │ ▶ Sub-flows  │  │  ┌──────┐   ┌──────┐  │  │             │ │
│  │   - Shariah  │  │  │Audit │   │Approve  │  │  Role:      │ │
│  │   - Audit    │  │  └──────┘   └──────┘  │  │  Shariah    │ │
│  │   - ESG      │  │      ↓         ↓       │  │  Advisor    │ │
│  │              │  │  ┌──────┐   ┌──────┐  │  │             │ │
│  │              │  │  │Issue │ →│ End  │  │  │  Duration:  │ │
│  │              │  │  └──────┘   └──────┘  │  │  2-3 days   │ │
│  │              │  │                         │  │             │ │
│  │              │  │  [Zoom controls]        │  │  [Details]  │ │
│  └──────────────┘  └────────────────────────┘  └─────────────┘ │
│   150-200px             Flexible width              300px       │
└──────────────────────────────────────────────────────────────────┘
```

### Component Structure

```
src/components/workflow/steps/Step8ReviewPolicyStructure.tsx
├── [Existing metadata cards]
├── WorkflowVisualization (NEW)
    ├── WorkflowNavigator (Left Panel)
    │   ├── Main Workflow (always expanded)
    │   └── Sub-Workflows (expandable/collapsible)
    ├── BpmnCanvas (Center)
    │   ├── BpmnViewer (bpmn-js wrapper)
    │   ├── Zoom controls
    │   └── Click handlers
    └── StepDetailsPanel (Right)
        ├── Step information
        ├── Role assignments
        ├── Input/output data
        └── Compliance checkpoints
```

## Data Model

### Policy Workflows Structure

```typescript
interface PolicyWorkflows {
  main: WorkflowDefinition
  subWorkflows: WorkflowDefinition[]
}

interface WorkflowDefinition {
  id: string
  name: string
  description: string
  bpmnXml: string  // BPMN 2.0 XML
  steps: WorkflowStep[]
  triggeredBy?: string  // For sub-workflows
}

interface WorkflowStep {
  id: string  // BPMN element ID
  name: string
  type: 'task' | 'gateway' | 'event' | 'subprocess'
  role?: string  // Required role (e.g., "Shariah Advisor")
  duration?: string  // Estimated duration
  inputData?: DataSchema[]
  outputData?: DataSchema[]
  complianceCheckpoints?: ComplianceCheck[]
  description?: string
}

interface DataSchema {
  name: string
  description: string
  required: boolean
  type: string  // e.g., "document", "number", "boolean"
}

interface ComplianceCheck {
  standard: string  // e.g., "AAOIFI FAS 33"
  requirement: string
  status: 'pass' | 'warning' | 'fail'
}
```

## Phase Implementation Strategy

### Phase 4A (Current - Mock Data)

**Goal:** Demonstrate BPMN visualization with realistic mock workflows

**Mock BPMN Generation:**
```typescript
function generateMockBPMN(execution: WorkflowExecution): string {
  // Generate BPMN 2.0 XML based on 4-component configuration

  const baseSteps = [
    { id: 'start', name: 'Start Event', type: 'startEvent' },
    { id: 'submit', name: 'Issuer submits application', type: 'task', role: 'Issuer' },
    { id: 'shariah', name: 'Shariah board review', type: 'task', role: 'Shariah Advisor' },
    // ... more steps based on configuration
  ]

  // Add jurisdiction-specific steps
  if (execution.selectedJurisdiction?.id === 'saudi_cma') {
    baseSteps.push({ id: 'cma_approval', name: 'CMA approval', type: 'task', role: 'CMA Officer' })
  }

  // Add accounting-specific steps
  if (execution.selectedAccounting?.id === 'aaoifi') {
    baseSteps.push({ id: 'aaoifi_audit', name: 'AAOIFI audit', type: 'task', role: 'AAOIFI Auditor' })
  }

  // Add impact metric verification steps
  execution.selectedImpacts?.forEach(impact => {
    baseSteps.push({ id: `verify_${impact.id}`, name: `Verify ${impact.name}`, type: 'task', role: 'ESG Verifier' })
  })

  return convertStepsToBPMN(baseSteps)
}
```

**Mock Sub-Workflows:**
- **Shariah Compliance Review** - Triggered by main workflow
- **AAOIFI Audit Process** - If AAOIFI accounting selected
- **ESG Impact Verification** - If impact metrics selected

### Phase 4B (Future - Real Guardian Integration)

**Goal:** Display actual Guardian policy BPMN from blockchain

**Backend Integration:**
```typescript
// In generatePolicyStructure()
const response = await fetch('/api/guardian/generate-policy', {
  method: 'POST',
  body: JSON.stringify({
    shariahStructure: execution.selectedShariahStructure,
    jurisdiction: execution.selectedJurisdiction,
    accounting: execution.selectedAccounting,
    impactMetrics: execution.selectedImpacts
  })
})

const { policy } = await response.json()
// policy.bpmnXml = actual BPMN 2.0 XML from Guardian
// policy.workflows.main = main workflow
// policy.workflows.subWorkflows = sub-workflows
```

**Guardian MCP Integration:**
- Guardian generates policy from 4-component configuration
- Returns BPMN 2.0 XML + metadata
- Frontend renders real policy that will execute on Hedera blockchain

## User Interactions

### Phase 4A (Read-Only Viewer)

**Allowed:**
- ✅ View main workflow BPMN diagram
- ✅ Zoom in/out (mouse wheel, buttons)
- ✅ Pan canvas (click + drag)
- ✅ Fit to screen (button)
- ✅ Switch between main/sub-workflows (navigator)
- ✅ Click steps to view details (right panel slides in)
- ✅ Hover steps for tooltips

**Not Allowed:**
- ❌ Edit workflow (no drag-drop, no step creation)
- ❌ Modify step properties
- ❌ Add/remove steps
- ❌ Change sequence flows

**Rationale:** Workflows are generated by Guardian and immutable. Users review, not design.

### Phase 4B (Same Read-Only)

**Note:** Even with real Guardian integration, workflows remain read-only. Guardian generates policies from configuration, users don't manually design workflows.

**Possible Future:** If Guardian supports policy customization API, we could enable editing.

## Step Details Panel Content

When user clicks a workflow step, show:

```typescript
interface StepDetails {
  // Basic Info
  name: string
  description: string
  type: string  // "User Task", "Service Task", "Gateway", etc.

  // Execution Info
  role: string  // "Shariah Advisor"
  estimatedDuration: string  // "2-3 business days"

  // Data Requirements
  inputData: {
    name: string
    description: string
    required: boolean
    type: string
    example?: string
  }[]

  outputData: {
    name: string
    description: string
    type: string
  }[]

  // Compliance
  complianceCheckpoints: {
    standard: string  // "AAOIFI FAS 33"
    requirement: string
    status: 'automated' | 'manual'
  }[]

  // Blockchain Info (Phase 4B)
  hederaTransactionType?: string
  estimatedHBARCost?: string
}
```

## Mock Workflow Examples

### Sukuk Issuance (Asset-Backed)

**Main Workflow Steps:**
1. Start Event
2. Issuer submits application (Issuer role)
3. Shariah board review (Shariah Advisor)
4. Gateway: Shariah approved?
   - Yes → Continue
   - No → Reject (End)
5. Asset valuation (External Auditor)
6. AAOIFI audit (if selected)
7. Jurisdiction approval (if Saudi CMA)
8. ESG verification (if impact metrics selected)
9. Pricing determination (Issuer)
10. Investor allocation (Issuer)
11. Settlement preparation (Issuer)
12. Final Shariah certification (Shariah Advisor)
13. Sukuk issuance complete (End Event)

**Sub-Workflow: Shariah Compliance Review**
- Triggered by: Step 3 (Shariah board review)
- Steps:
  1. Review Sukuk structure
  2. Verify asset ownership
  3. Check profit-sharing ratios
  4. Validate compliance with AAOIFI standards
  5. Issue certificate

### Murabaha (Trade Financing)

**Main Workflow Steps:**
1. Start Event
2. Customer requests financing (Customer role)
3. Bank identifies asset (Bank role)
4. Bank purchases asset (Bank role)
5. Shariah review (Shariah Advisor)
6. Gateway: Approved?
7. Markup calculation (Bank)
8. Customer acceptance (Customer)
9. Asset transfer to customer (Bank)
10. Payment schedule initiation (Bank)
11. End Event

## Testing Strategy

### Mock Data Testing

**Test Cases:**
1. **Minimal Configuration**
   - Shariah: Murabaha
   - Jurisdiction: Malaysia SC
   - Accounting: IFRS Islamic
   - Impact: None
   - Expected: 8-10 workflow steps

2. **Complex Configuration (QIIB Oryx Demo)**
   - Shariah: Sukuk (asset-backed)
   - Jurisdiction: Saudi CMA
   - Accounting: AAOIFI
   - Impact: IOSCO ESG + SDG Impact Standards
   - Expected: 15-20 workflow steps + 3 sub-workflows

3. **All Components Selected**
   - Maximum complexity
   - All impact metrics selected
   - Expected: 20+ workflow steps + multiple sub-workflows

### Visual Testing

**Verify:**
- ✅ BPMN diagram renders correctly
- ✅ All steps visible and labeled
- ✅ Sequence flows connect properly
- ✅ Gateways show decision points
- ✅ Sub-workflows display in navigator
- ✅ Zoom/pan works smoothly
- ✅ Click handlers trigger details panel
- ✅ Details panel shows correct step info
- ✅ Responsive layout (no overflow, proper sizing)

## Technical Considerations

### BPMN XML Generation

**Minimal BPMN 2.0 Structure:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             id="definitions"
             targetNamespace="http://zeroh.ai/bpmn">

  <process id="sukuk_issuance" name="Sukuk Issuance Workflow">
    <startEvent id="start" name="Start" />
    <sequenceFlow id="flow1" sourceRef="start" targetRef="submit" />

    <userTask id="submit" name="Issuer submits application">
      <performer>Issuer</performer>
    </userTask>
    <sequenceFlow id="flow2" sourceRef="submit" targetRef="shariah_review" />

    <userTask id="shariah_review" name="Shariah board review">
      <performer>Shariah Advisor</performer>
    </userTask>
    <!-- ... more tasks ... -->

    <endEvent id="end" name="End" />
  </process>

  <!-- Diagram information for positioning -->
  <bpmndi:BPMNDiagram id="diagram">
    <bpmndi:BPMNPlane id="plane" bpmnElement="sukuk_issuance">
      <!-- Shape positions -->
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
```

### bpmn-js Configuration

```typescript
import BpmnViewer from 'bpmn-js/lib/Viewer'

const viewer = new BpmnViewer({
  container: '#canvas',
  keyboard: { bindTo: document },
  // Read-only configuration
  additionalModules: [
    // No editing modules
  ]
})

await viewer.importXML(bpmnXml)

// Add click handler
const eventBus = viewer.get('eventBus')
eventBus.on('element.click', (event) => {
  const { element } = event
  showStepDetails(element.id)
})
```

### Performance Considerations

**BPMN Rendering:**
- bpmn-js uses SVG rendering (performant for 100+ nodes)
- Lazy load sub-workflows (only render when selected)
- Debounce zoom/pan events

**Bundle Size:**
- bpmn-js core: ~200KB gzipped
- Only import Viewer (not Modeler) to reduce size

## Success Criteria

✅ **User can see what workflow will execute**
- BPMN diagram displays with all steps
- Steps are labeled with names and roles
- Sequence flows show execution order

✅ **User can understand workflow structure**
- Decision points (gateways) are visible
- Sub-workflows are discoverable
- Parallel execution paths are clear

✅ **User can inspect step details**
- Click any step to see role, data, compliance info
- Details panel provides actionable information
- Duration estimates help planning

✅ **Design is professional and intuitive**
- ServiceNow-inspired layout is familiar
- BPMN standard notation is recognizable
- UI is clean and business-appropriate

✅ **Works with all configurations**
- Minimal configuration (few steps)
- Complex configuration (many steps, sub-workflows)
- QIIB Oryx Demo scenario

## Future Enhancements (Post-Phase 4B)

### Possible Improvements:

1. **Historical Execution Overlay**
   - Show average actual duration for each step
   - Highlight bottleneck steps (taking longer than expected)

2. **Live Execution Tracking** (Step 11)
   - Show current step in workflow
   - Highlight completed steps (green)
   - Show pending steps (gray)
   - Update in real-time as workflow executes on Hedera

3. **Workflow Comparison**
   - Compare main workflow vs actual execution
   - Show deviations (if Guardian supports ad-hoc changes)

4. **Export Options**
   - Download BPMN XML
   - Export as PNG/SVG image
   - Print-friendly view

5. **Accessibility**
   - Keyboard navigation for steps
   - Screen reader support
   - High contrast mode

## Dependencies

```json
{
  "dependencies": {
    "bpmn-js": "^14.0.0",
    "diagram-js": "^12.0.0"
  },
  "devDependencies": {
    "@types/bpmn-js": "^0.0.8"
  }
}
```

## References

- [BPMN 2.0 Specification](https://www.omg.org/spec/BPMN/2.0/)
- [bpmn-js Documentation](https://bpmn.io/toolkit/bpmn-js/)
- [Guardian Policy Structure](https://docs.hedera.com/guardian/)
- [ServiceNow Flow Designer](https://docs.servicenow.com/bundle/washington-application-development/page/administer/flow-designer/concept/flow-designer.html)

## Open Questions

1. **Sub-workflow trigger mechanism:** How does Guardian define when sub-workflows are triggered? Is it explicit in BPMN (call activity) or implicit in policy config?

2. **Role mapping:** How do Guardian roles map to our 4-component roles (e.g., "Shariah Advisor" in config vs "SHARIAH_BOARD_MEMBER" in Guardian)?

3. **Data schema format:** What format does Guardian use for input/output data schemas? JSON Schema? Custom format?

4. **Gateway types:** Which BPMN gateway types does Guardian support? (Exclusive, Parallel, Inclusive, Event-based?)

## Timeline

**Sprint 1 (Current):**
- ✅ Create context document
- ⏳ Install dependencies
- ⏳ Create BpmnViewer component
- ⏳ Generate mock BPMN for Sukuk

**Sprint 2:**
- Update Step 8 layout
- Integrate BPMN viewer
- Add step details panel

**Sprint 3:**
- Test with all configurations
- Polish UI/UX
- Documentation

**Phase 4B:**
- Replace mock BPMN with real Guardian BPMN
- Test with real policy execution
